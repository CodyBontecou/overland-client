<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Overland | Location Journal</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,600;1,400&family=JetBrains+Mono:wght@400;500&family=Playfair+Display:wght@500;700&display=swap" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <style>
    :root {
      --parchment: #f7f3eb;
      --parchment-dark: #ebe5d8;
      --ink: #2a2520;
      --ink-light: #5c554a;
      --terracotta: #c45a3b;
      --terracotta-glow: #e8724f;
      --forest: #2d5a47;
      --forest-light: #4a8b6f;
      --ochre: #d4a84b;
      --shadow: rgba(42, 37, 32, 0.12);
      --shadow-deep: rgba(42, 37, 32, 0.25);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      font-size: 16px;
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Crimson Pro', Georgia, serif;
      background: var(--parchment);
      color: var(--ink);
      min-height: 100vh;
      line-height: 1.6;
      position: relative;
      overflow-x: hidden;
    }

    /* Topographic background pattern */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        repeating-radial-gradient(
          ellipse 800px 600px at 20% 30%,
          transparent,
          transparent 80px,
          rgba(45, 90, 71, 0.03) 81px,
          rgba(45, 90, 71, 0.03) 82px,
          transparent 83px
        ),
        repeating-radial-gradient(
          ellipse 600px 500px at 70% 60%,
          transparent,
          transparent 60px,
          rgba(196, 90, 59, 0.02) 61px,
          rgba(196, 90, 59, 0.02) 62px,
          transparent 63px
        ),
        repeating-radial-gradient(
          ellipse 400px 350px at 40% 80%,
          transparent,
          transparent 45px,
          rgba(45, 90, 71, 0.025) 46px,
          rgba(45, 90, 71, 0.025) 47px,
          transparent 48px
        );
      pointer-events: none;
      z-index: 0;
    }

    /* Grain texture overlay */
    body::after {
      content: '';
      position: fixed;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
      opacity: 0.03;
      pointer-events: none;
      z-index: 1;
    }

    .app {
      position: relative;
      z-index: 2;
      max-width: 1100px;
      margin: 0 auto;
      padding: 2rem 1.5rem 4rem;
    }

    /* Header */
    header {
      text-align: center;
      padding: 3rem 0 4rem;
      border-bottom: 1px solid rgba(45, 90, 71, 0.15);
      margin-bottom: 3rem;
      position: relative;
    }

    header::after {
      content: '~ est. 2024 ~';
      position: absolute;
      bottom: -0.7rem;
      left: 50%;
      transform: translateX(-50%);
      background: var(--parchment);
      padding: 0 1rem;
      font-size: 0.75rem;
      letter-spacing: 0.2em;
      color: var(--ink-light);
      text-transform: uppercase;
    }

    .logo {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 0.5rem;
    }

    .logo-icon {
      width: 48px;
      height: 48px;
      position: relative;
    }

    .logo-icon::before {
      content: '';
      position: absolute;
      inset: 0;
      border: 2px solid var(--terracotta);
      border-radius: 50%;
      animation: compass-spin 20s linear infinite;
    }

    .logo-icon::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      background: var(--terracotta);
      clip-path: polygon(50% 0%, 100% 100%, 50% 75%, 0% 100%);
      transform: translate(-50%, -60%);
    }

    @keyframes compass-spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    h1 {
      font-family: 'Playfair Display', serif;
      font-size: 2.75rem;
      font-weight: 700;
      letter-spacing: 0.02em;
      color: var(--ink);
    }

    .tagline {
      font-style: italic;
      color: var(--ink-light);
      font-size: 1.1rem;
      margin-top: 0.25rem;
    }

    /* Latest Location Hero */
    .hero {
      background: linear-gradient(135deg, var(--parchment-dark) 0%, var(--parchment) 100%);
      border: 1px solid rgba(45, 90, 71, 0.2);
      border-radius: 4px;
      padding: 2.5rem;
      margin-bottom: 3rem;
      position: relative;
      box-shadow:
        0 4px 20px var(--shadow),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
    }

    .hero::before {
      content: '';
      position: absolute;
      top: 12px;
      right: 12px;
      width: 60px;
      height: 60px;
      border: 1px solid var(--forest);
      opacity: 0.2;
    }

    .hero::after {
      content: '';
      position: absolute;
      top: 20px;
      right: 20px;
      width: 44px;
      height: 44px;
      border: 1px solid var(--forest);
      opacity: 0.15;
    }

    .hero-label {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: var(--terracotta);
      margin-bottom: 1.5rem;
    }

    .hero-label .pulse {
      width: 8px;
      height: 8px;
      background: var(--terracotta);
      border-radius: 50%;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }

    .hero-coords {
      font-family: 'JetBrains Mono', monospace;
      font-size: 2rem;
      font-weight: 500;
      letter-spacing: -0.02em;
      margin-bottom: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem 2rem;
    }

    .coord {
      display: flex;
      align-items: baseline;
      gap: 0.5rem;
    }

    .coord-label {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--ink-light);
    }

    .coord-value {
      color: var(--forest);
    }

    .hero-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem 3rem;
      padding-top: 1.5rem;
      border-top: 1px dashed rgba(45, 90, 71, 0.2);
      font-size: 0.95rem;
    }

    .meta-item {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .meta-label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--ink-light);
    }

    .meta-value {
      font-weight: 600;
    }

    .hero-empty {
      text-align: center;
      padding: 2rem;
      color: var(--ink-light);
      font-style: italic;
    }

    /* Controls Section */
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: flex-end;
      margin-bottom: 2rem;
      padding-bottom: 2rem;
      border-bottom: 1px solid rgba(45, 90, 71, 0.1);
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .filter-group label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--ink-light);
    }

    .filter-group input {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
      padding: 0.6rem 0.8rem;
      border: 1px solid rgba(45, 90, 71, 0.25);
      border-radius: 3px;
      background: rgba(255, 255, 255, 0.6);
      color: var(--ink);
      transition: all 0.2s ease;
    }

    .filter-group input:focus {
      outline: none;
      border-color: var(--forest);
      box-shadow: 0 0 0 3px rgba(45, 90, 71, 0.1);
    }

    .btn {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      padding: 0.7rem 1.4rem;
      border: 1px solid var(--forest);
      background: transparent;
      color: var(--forest);
      cursor: pointer;
      transition: all 0.25s ease;
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background: var(--forest);
      transform: translateY(100%);
      transition: transform 0.25s ease;
      z-index: -1;
    }

    .btn:hover {
      color: var(--parchment);
    }

    .btn:hover::before {
      transform: translateY(0);
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn-secondary {
      border-color: var(--ink-light);
      color: var(--ink-light);
    }

    .btn-secondary::before {
      background: var(--ink-light);
    }

    /* Location List */
    .locations-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 1.5rem;
    }

    .locations-header h2 {
      font-family: 'Playfair Display', serif;
      font-size: 1.5rem;
      font-weight: 500;
    }

    .locations-count {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      color: var(--ink-light);
    }

    .locations-list {
      display: flex;
      flex-direction: column;
      gap: 1px;
      background: rgba(45, 90, 71, 0.1);
      border-radius: 4px;
      overflow: hidden;
    }

    .location-card {
      background: var(--parchment);
      padding: 1.25rem 1.5rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 1.5rem;
      align-items: center;
      position: relative;
    }

    .location-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: var(--terracotta);
      transform: scaleY(0);
      transition: transform 0.2s ease;
    }

    .location-card:hover {
      background: var(--parchment-dark);
    }

    .location-card:hover::before {
      transform: scaleY(1);
    }

    .location-index {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.7rem;
      color: var(--ink-light);
      width: 2.5rem;
      text-align: right;
    }

    .location-main {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .location-coords {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9rem;
      color: var(--forest);
    }

    .location-time {
      font-size: 0.85rem;
      color: var(--ink-light);
    }

    .location-badges {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .badge {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.6rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 0.25rem 0.5rem;
      border-radius: 2px;
      background: rgba(45, 90, 71, 0.1);
      color: var(--forest);
    }

    .badge-motion {
      background: rgba(196, 90, 59, 0.1);
      color: var(--terracotta);
    }

    .location-arrow {
      color: var(--ink-light);
      font-size: 1.2rem;
      opacity: 0;
      transform: translateX(-5px);
      transition: all 0.2s ease;
    }

    .location-card:hover .location-arrow {
      opacity: 1;
      transform: translateX(0);
    }

    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 1px solid rgba(45, 90, 71, 0.1);
    }

    .pagination-info {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      color: var(--ink-light);
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .btn:disabled:hover {
      color: inherit;
    }

    .btn:disabled::before {
      display: none;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(42, 37, 32, 0.7);
      backdrop-filter: blur(4px);
      z-index: 100;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.95);
      background: var(--parchment);
      border-radius: 4px;
      max-width: 600px;
      width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      z-index: 101;
      box-shadow: 0 25px 80px var(--shadow-deep);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal.active {
      opacity: 1;
      visibility: visible;
      transform: translate(-50%, -50%) scale(1);
    }

    .modal-header {
      padding: 1.5rem 2rem;
      border-bottom: 1px solid rgba(45, 90, 71, 0.15);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.25rem;
      font-weight: 500;
    }

    .modal-close {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 1.5rem;
      color: var(--ink-light);
      transition: color 0.2s ease;
    }

    .modal-close:hover {
      color: var(--terracotta);
    }

    .modal-body {
      padding: 2rem;
    }

    .detail-section {
      margin-bottom: 2rem;
    }

    .detail-section:last-child {
      margin-bottom: 0;
    }

    .detail-section-title {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: var(--terracotta);
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px dashed rgba(196, 90, 59, 0.3);
    }

    .detail-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }

    .detail-item {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .detail-item.full-width {
      grid-column: 1 / -1;
    }

    .detail-label {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.6rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--ink-light);
    }

    .detail-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9rem;
      color: var(--forest);
    }

    .detail-value.large {
      font-size: 1.5rem;
      font-weight: 500;
    }

    /* Loading State */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 4rem 2rem;
      gap: 1rem;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 2px solid rgba(45, 90, 71, 0.2);
      border-top-color: var(--forest);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      font-style: italic;
      color: var(--ink-light);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--ink-light);
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.3;
    }

    .empty-state-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.25rem;
      margin-bottom: 0.5rem;
      color: var(--ink);
    }

    /* Error State */
    .error-state {
      background: rgba(196, 90, 59, 0.1);
      border: 1px solid rgba(196, 90, 59, 0.3);
      border-radius: 4px;
      padding: 1.5rem;
      text-align: center;
      color: var(--terracotta);
    }

    /* Auth UI */
    .auth-container {
      position: absolute;
      top: 1rem;
      right: 0;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid var(--forest);
    }

    .user-name {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      color: var(--ink);
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .btn-small {
      padding: 0.5rem 0.75rem;
      font-size: 0.65rem;
    }

    .btn-login {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      background: var(--ink);
      color: var(--parchment);
      border-color: var(--ink);
    }

    .btn-login:hover {
      background: var(--forest);
      border-color: var(--forest);
    }

    .btn-login::before {
      display: none;
    }

    .github-icon {
      width: 14px;
      height: 14px;
      fill: currentColor;
    }

    /* Token Management */
    .token-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .token-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: var(--parchment-dark);
      border-radius: 4px;
    }

    .token-info {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .token-name {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
      color: var(--forest);
      font-weight: 500;
    }

    .token-meta {
      font-size: 0.7rem;
      color: var(--ink-light);
    }

    .token-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      background: var(--ink);
      color: var(--parchment);
      padding: 0.75rem 1rem;
      border-radius: 4px;
      word-break: break-all;
      margin: 1rem 0;
    }

    .token-warning {
      background: rgba(196, 90, 59, 0.1);
      border: 1px solid var(--terracotta);
      padding: 0.75rem;
      border-radius: 4px;
      font-size: 0.8rem;
      color: var(--terracotta);
      margin-bottom: 1rem;
    }

    .btn-danger {
      border-color: var(--terracotta);
      color: var(--terracotta);
    }

    .btn-danger::before {
      background: var(--terracotta);
    }

    .create-token-form {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }

    .create-token-form input {
      flex: 1;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
      padding: 0.6rem 0.8rem;
      border: 1px solid rgba(45, 90, 71, 0.25);
      border-radius: 3px;
      background: rgba(255, 255, 255, 0.6);
      color: var(--ink);
    }

    .create-token-form input:focus {
      outline: none;
      border-color: var(--forest);
      box-shadow: 0 0 0 3px rgba(45, 90, 71, 0.1);
    }

    .token-instructions {
      margin-bottom: 1.5rem;
      color: var(--ink-light);
      font-size: 0.9rem;
      line-height: 1.5;
    }

    @media (max-width: 640px) {
      .auth-container {
        position: static;
        justify-content: center;
        margin-top: 1rem;
      }

      .user-name {
        display: none;
      }
    }

    /* Animations */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-in {
      animation: fadeInUp 0.4s ease forwards;
    }

    .stagger-1 { animation-delay: 0.05s; }
    .stagger-2 { animation-delay: 0.1s; }
    .stagger-3 { animation-delay: 0.15s; }
    .stagger-4 { animation-delay: 0.2s; }
    .stagger-5 { animation-delay: 0.25s; }

    /* Responsive */
    @media (max-width: 640px) {
      .app {
        padding: 1rem;
      }

      h1 {
        font-size: 2rem;
      }

      .hero {
        padding: 1.5rem;
      }

      .hero-coords {
        font-size: 1.25rem;
      }

      .controls {
        flex-direction: column;
        align-items: stretch;
      }

      .filter-group {
        width: 100%;
      }

      .filter-group input {
        width: 100%;
      }

      .location-card {
        grid-template-columns: 1fr;
        gap: 0.75rem;
      }

      .location-index {
        text-align: left;
      }

      .location-arrow {
        display: none;
      }

      .detail-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Expedition Map */
    .map-section {
      margin-bottom: 3rem;
    }

    .map-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 1rem;
    }

    .map-header h2 {
      font-family: 'Playfair Display', serif;
      font-size: 1.5rem;
      font-weight: 500;
    }

    .map-stats {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.7rem;
      color: var(--ink-light);
      display: flex;
      gap: 1.5rem;
    }

    .map-container {
      position: relative;
      height: 450px;
      border-radius: 4px;
      overflow: hidden;
      box-shadow:
        0 4px 20px var(--shadow),
        inset 0 0 0 1px rgba(45, 90, 71, 0.2);
    }

    /* Decorative map frame corners */
    .map-container::before,
    .map-container::after {
      content: '';
      position: absolute;
      width: 40px;
      height: 40px;
      border: 2px solid var(--terracotta);
      z-index: 1000;
      pointer-events: none;
      opacity: 0.6;
    }

    .map-container::before {
      top: 12px;
      left: 12px;
      border-right: none;
      border-bottom: none;
    }

    .map-container::after {
      bottom: 12px;
      right: 12px;
      border-left: none;
      border-top: none;
    }

    .map-frame-tr,
    .map-frame-bl {
      position: absolute;
      width: 40px;
      height: 40px;
      border: 2px solid var(--terracotta);
      z-index: 1000;
      pointer-events: none;
      opacity: 0.6;
    }

    .map-frame-tr {
      top: 12px;
      right: 12px;
      border-left: none;
      border-bottom: none;
    }

    .map-frame-bl {
      bottom: 12px;
      left: 12px;
      border-right: none;
      border-top: none;
    }

    #expeditionMap {
      height: 100%;
      width: 100%;
      background: var(--parchment-dark);
    }

    /* Sepia filter for vintage map look */
    .leaflet-tile-pane {
      filter: sepia(0.15) saturate(0.9) brightness(1.02);
    }

    /* Custom Leaflet popup styling */
    .leaflet-popup-content-wrapper {
      background: var(--parchment);
      border-radius: 4px;
      box-shadow: 0 4px 20px var(--shadow-deep);
      border: 1px solid rgba(45, 90, 71, 0.2);
    }

    .leaflet-popup-content {
      font-family: 'Crimson Pro', Georgia, serif;
      color: var(--ink);
      margin: 12px 16px;
      line-height: 1.5;
    }

    .leaflet-popup-tip {
      background: var(--parchment);
      border: 1px solid rgba(45, 90, 71, 0.2);
      border-top: none;
      border-left: none;
    }

    .popup-content {
      min-width: 180px;
    }

    .popup-coords {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
      color: var(--forest);
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .popup-time {
      font-size: 0.9rem;
      color: var(--ink-light);
      border-top: 1px dashed rgba(45, 90, 71, 0.2);
      padding-top: 0.5rem;
      margin-top: 0.5rem;
    }

    .popup-meta {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.7rem;
      color: var(--ink-light);
      margin-top: 0.5rem;
    }

    /* Leaflet control overrides */
    .leaflet-control-zoom {
      border: 1px solid rgba(45, 90, 71, 0.3) !important;
      border-radius: 4px !important;
      overflow: hidden;
    }

    .leaflet-control-zoom a {
      background: var(--parchment) !important;
      color: var(--forest) !important;
      border-color: rgba(45, 90, 71, 0.2) !important;
      font-family: 'JetBrains Mono', monospace !important;
      transition: all 0.2s ease;
    }

    .leaflet-control-zoom a:hover {
      background: var(--forest) !important;
      color: var(--parchment) !important;
    }

    .leaflet-control-attribution {
      background: rgba(247, 243, 235, 0.85) !important;
      font-family: 'JetBrains Mono', monospace !important;
      font-size: 0.6rem !important;
      color: var(--ink-light) !important;
    }

    .map-legend {
      position: absolute;
      bottom: 40px;
      left: 12px;
      z-index: 1000;
      background: rgba(247, 243, 235, 0.95);
      padding: 0.75rem 1rem;
      border-radius: 4px;
      border: 1px solid rgba(45, 90, 71, 0.2);
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--ink-light);
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: 2px solid var(--terracotta);
      background: var(--parchment);
    }

    .legend-dot.current {
      background: var(--terracotta);
      box-shadow: 0 0 0 3px rgba(196, 90, 59, 0.3);
    }

    .legend-line {
      width: 20px;
      height: 3px;
      background: var(--forest);
      opacity: 0.7;
      border-radius: 2px;
    }

    .map-loading {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--parchment-dark);
      z-index: 500;
    }

    @media (max-width: 640px) {
      .map-container {
        height: 350px;
      }

      .map-stats {
        display: none;
      }

      .map-legend {
        bottom: 30px;
        padding: 0.5rem 0.75rem;
        font-size: 0.6rem;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="auth-container" id="authContainer"></div>
      <div class="logo">
        <div class="logo-icon"></div>
        <h1>Overland</h1>
      </div>
      <p class="tagline">Your personal location journal</p>
    </header>

    <!-- Latest Location Hero -->
    <section class="hero" id="heroSection">
      <div class="loading">
        <div class="loading-spinner"></div>
        <span class="loading-text">Fetching latest position...</span>
      </div>
    </section>

    <!-- Expedition Map -->
    <section class="map-section">
      <div class="map-header">
        <h2>Expedition Map</h2>
        <div class="map-stats">
          <span id="mapPointCount">— points plotted</span>
          <span id="mapDateRange">—</span>
        </div>
      </div>
      <div class="map-container">
        <div class="map-frame-tr"></div>
        <div class="map-frame-bl"></div>
        <div id="expeditionMap"></div>
        <div class="map-legend">
          <div class="legend-item">
            <span class="legend-dot current"></span>
            <span>Latest position</span>
          </div>
          <div class="legend-item">
            <span class="legend-dot"></span>
            <span>Recorded point</span>
          </div>
          <div class="legend-item">
            <span class="legend-line"></span>
            <span>Travel path</span>
          </div>
        </div>
        <div class="map-loading" id="mapLoading">
          <div class="loading">
            <div class="loading-spinner"></div>
            <span class="loading-text">Charting coordinates...</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Controls -->
    <section class="controls">
      <div class="filter-group">
        <label for="fromDate">From</label>
        <input type="datetime-local" id="fromDate">
      </div>
      <div class="filter-group">
        <label for="toDate">To</label>
        <input type="datetime-local" id="toDate">
      </div>
      <button class="btn" id="applyFilter">Apply Filter</button>
      <button class="btn btn-secondary" id="clearFilter">Clear</button>
    </section>

    <!-- Location History -->
    <section class="locations-section">
      <div class="locations-header">
        <h2>Location History</h2>
        <span class="locations-count" id="locationsCount"></span>
      </div>
      <div id="locationsList">
        <div class="loading">
          <div class="loading-spinner"></div>
          <span class="loading-text">Loading expedition log...</span>
        </div>
      </div>
      <div class="pagination" id="pagination" style="display: none;">
        <button class="btn btn-secondary" id="prevPage">Previous</button>
        <span class="pagination-info" id="paginationInfo"></span>
        <button class="btn btn-secondary" id="nextPage">Next</button>
      </div>
    </section>
  </div>

  <!-- Detail Modal -->
  <div class="modal-overlay" id="modalOverlay"></div>
  <div class="modal" id="detailModal">
    <div class="modal-header">
      <h3 class="modal-title">Location Details</h3>
      <button class="modal-close" id="modalClose">&times;</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>

  <script>
    const API_BASE = '/api';
    const LIMIT = 20;

    let currentOffset = 0;
    let totalLocations = 0;
    let filters = { from: null, to: null };
    let currentUser = null;
    let newTokenValue = null;

    // DOM Elements
    const authContainer = document.getElementById('authContainer');
    const heroSection = document.getElementById('heroSection');
    const locationsList = document.getElementById('locationsList');
    const locationsCount = document.getElementById('locationsCount');
    const pagination = document.getElementById('pagination');
    const paginationInfo = document.getElementById('paginationInfo');
    const prevPageBtn = document.getElementById('prevPage');
    const nextPageBtn = document.getElementById('nextPage');
    const fromDateInput = document.getElementById('fromDate');
    const toDateInput = document.getElementById('toDate');
    const applyFilterBtn = document.getElementById('applyFilter');
    const clearFilterBtn = document.getElementById('clearFilter');
    const modalOverlay = document.getElementById('modalOverlay');
    const detailModal = document.getElementById('detailModal');
    const modalClose = document.getElementById('modalClose');
    const modalBody = document.getElementById('modalBody');
    const mapLoading = document.getElementById('mapLoading');
    const mapPointCount = document.getElementById('mapPointCount');
    const mapDateRange = document.getElementById('mapDateRange');

    // Map state
    let expeditionMap = null;
    let mapMarkers = [];
    let pathLine = null;
    let currentMarker = null;

    // Initialize map
    function initMap() {
      expeditionMap = L.map('expeditionMap', {
        zoomControl: true,
        scrollWheelZoom: true
      }).setView([40.7128, -74.0060], 12);

      // CartoDB Positron - clean minimal aesthetic (free, no auth required)
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 20,
        subdomains: 'abcd',
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/attributions">CARTO</a>'
      }).addTo(expeditionMap);
    }

    // Create custom marker icon
    function createMarkerIcon(isCurrent = false) {
      const size = isCurrent ? 16 : 10;
      const className = isCurrent ? 'current-marker' : 'path-marker';

      return L.divIcon({
        className: className,
        html: `<div style="
          width: ${size}px;
          height: ${size}px;
          background: ${isCurrent ? '#c45a3b' : '#f7f3eb'};
          border: 2px solid #c45a3b;
          border-radius: 50%;
          box-shadow: ${isCurrent ? '0 0 0 4px rgba(196, 90, 59, 0.3), 0 2px 8px rgba(0,0,0,0.2)' : '0 2px 6px rgba(0,0,0,0.15)'};
          ${isCurrent ? 'animation: pulse 2s ease-in-out infinite;' : ''}
        "></div>`,
        iconSize: [size, size],
        iconAnchor: [size / 2, size / 2],
        popupAnchor: [0, -size / 2 - 4]
      });
    }

    // Format date for display
    function formatMapDate(isoString) {
      const date = new Date(isoString);
      return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      });
    }

    // Update map with locations
    function updateMap(locations, isLatest = null) {
      if (!expeditionMap) return;

      // Clear existing markers and path
      mapMarkers.forEach(m => m.remove());
      mapMarkers = [];
      if (pathLine) pathLine.remove();
      if (currentMarker) currentMarker.remove();

      if (!locations || locations.length === 0) {
        mapLoading.style.display = 'none';
        mapPointCount.textContent = '0 points plotted';
        mapDateRange.textContent = '';
        return;
      }

      // Sort by timestamp (oldest first for path drawing)
      const sortedLocs = [...locations].sort((a, b) =>
        new Date(a.timestamp) - new Date(b.timestamp)
      );

      // Create path coordinates
      const pathCoords = sortedLocs.map(loc => [loc.latitude, loc.longitude]);

      // Draw the travel path
      pathLine = L.polyline(pathCoords, {
        color: '#2d5a47',
        weight: 3,
        opacity: 0.6,
        smoothFactor: 1,
        lineCap: 'round',
        lineJoin: 'round',
        dashArray: '8, 4'
      }).addTo(expeditionMap);

      // Add markers for each location (sample to avoid overcrowding)
      const markerInterval = Math.max(1, Math.floor(sortedLocs.length / 50));

      sortedLocs.forEach((loc, index) => {
        // Only add markers at intervals, plus first and last
        if (index !== 0 && index !== sortedLocs.length - 1 && index % markerInterval !== 0) {
          return;
        }

        const isCurrentPos = isLatest && loc.id === isLatest.id;
        const marker = L.marker([loc.latitude, loc.longitude], {
          icon: createMarkerIcon(isCurrentPos)
        });

        const popupContent = `
          <div class="popup-content">
            <div class="popup-coords">${formatCoord(loc.latitude, true)}, ${formatCoord(loc.longitude, false)}</div>
            <div class="popup-time">${formatTime(loc.timestamp)}</div>
            ${loc.speed != null ? `<div class="popup-meta">Speed: ${(loc.speed * 3.6).toFixed(1)} km/h</div>` : ''}
            ${loc.altitude != null ? `<div class="popup-meta">Alt: ${loc.altitude.toFixed(0)} m</div>` : ''}
          </div>
        `;

        marker.bindPopup(popupContent);
        marker.addTo(expeditionMap);

        if (isCurrentPos) {
          currentMarker = marker;
        } else {
          mapMarkers.push(marker);
        }
      });

      // Fit map to show all points
      if (pathCoords.length > 0) {
        const bounds = L.latLngBounds(pathCoords);
        expeditionMap.fitBounds(bounds, { padding: [50, 50] });
      }

      // Update stats
      mapPointCount.textContent = `${locations.length} points plotted`;

      if (sortedLocs.length > 1) {
        const oldest = formatMapDate(sortedLocs[0].timestamp);
        const newest = formatMapDate(sortedLocs[sortedLocs.length - 1].timestamp);
        mapDateRange.textContent = oldest === newest ? oldest : `${oldest} — ${newest}`;
      } else if (sortedLocs.length === 1) {
        mapDateRange.textContent = formatMapDate(sortedLocs[0].timestamp);
      }

      mapLoading.style.display = 'none';
    }

    // Fetch all locations for map (paginated to get everything)
    async function fetchMapLocations() {
      const allLocations = [];
      let offset = 0;
      const batchSize = 500;
      let hasMore = true;

      try {
        while (hasMore) {
          const params = new URLSearchParams({ limit: batchSize, offset });
          if (filters.from) params.append('from', filters.from);
          if (filters.to) params.append('to', filters.to);

          const response = await fetch(`${API_BASE}/locations?${params}`, { credentials: 'include' });
          if (response.status === 401) throw new Error('Unauthorized');
          if (!response.ok) throw new Error('Failed to fetch');

          const data = await response.json();
          if (data.data && data.data.length > 0) {
            allLocations.push(...data.data);
            offset += batchSize;
            hasMore = data.pagination.hasMore;
          } else {
            hasMore = false;
          }
        }

        return { data: allLocations, pagination: { total: allLocations.length } };
      } catch (error) {
        console.error('Error fetching map locations:', error);
        return null;
      }
    }

    // Load map data
    async function loadMapData(latestLocation = null) {
      mapLoading.style.display = 'flex';
      const response = await fetchMapLocations();
      if (response && response.data) {
        updateMap(response.data, latestLocation);
      } else {
        mapLoading.style.display = 'none';
      }
    }

    // Auth Functions
    async function checkAuth() {
      try {
        const response = await fetch(`${API_BASE}/me`, { credentials: 'include' });
        if (response.ok) {
          currentUser = await response.json();
          renderAuthUI();
          return true;
        }
      } catch (error) {
        console.error('Auth check failed:', error);
      }
      currentUser = null;
      renderAuthUI();
      return false;
    }

    function renderAuthUI() {
      if (currentUser) {
        authContainer.innerHTML = `
          <div class="user-info">
            ${currentUser.avatarUrl ? `<img src="${currentUser.avatarUrl}" alt="" class="user-avatar">` : ''}
            <span class="user-name">${currentUser.name || currentUser.email || 'User'}</span>
          </div>
          <button class="btn btn-small" id="manageTokensBtn">Tokens</button>
          <button class="btn btn-secondary btn-small" id="logoutBtn">Logout</button>
        `;
        document.getElementById('manageTokensBtn').addEventListener('click', openTokenModal);
        document.getElementById('logoutBtn').addEventListener('click', handleLogout);
      } else {
        authContainer.innerHTML = `
          <button class="btn btn-login btn-small" id="loginBtn">
            <svg class="github-icon" viewBox="0 0 16 16">
              <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
            </svg>
            Login with GitHub
          </button>
        `;
        document.getElementById('loginBtn').addEventListener('click', handleLogin);
      }
    }

    async function handleLogin() {
      try {
        const response = await fetch('/api/auth/sign-in/social', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ provider: 'github' })
        });
        const data = await response.json();
        if (data.url) {
          window.location.href = data.url;
        }
      } catch (error) {
        console.error('Login failed:', error);
      }
    }

    async function handleLogout() {
      try {
        await fetch('/api/auth/sign-out', { method: 'POST', credentials: 'include' });
      } catch (error) {
        console.error('Logout failed:', error);
      }
      currentUser = null;
      renderAuthUI();
      window.location.reload();
    }

    // Token Management
    async function fetchTokens() {
      const response = await fetch(`${API_BASE}/tokens`, { credentials: 'include' });
      if (!response.ok) throw new Error('Failed to fetch tokens');
      return await response.json();
    }

    async function createToken(name) {
      const response = await fetch(`${API_BASE}/tokens`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ name })
      });
      if (!response.ok) throw new Error('Failed to create token');
      return await response.json();
    }

    async function deleteToken(id) {
      const response = await fetch(`${API_BASE}/tokens/${id}`, {
        method: 'DELETE',
        credentials: 'include'
      });
      if (!response.ok) throw new Error('Failed to delete token');
    }

    async function openTokenModal() {
      modalOverlay.classList.add('active');
      detailModal.classList.add('active');
      document.body.style.overflow = 'hidden';
      newTokenValue = null;
      await renderTokenModal();
    }

    async function renderTokenModal() {
      const modalTitle = document.querySelector('.modal-title');
      modalTitle.textContent = 'Device Tokens';

      modalBody.innerHTML = `
        <div class="loading">
          <div class="loading-spinner"></div>
          <span class="loading-text">Loading tokens...</span>
        </div>
      `;

      try {
        const { tokens } = await fetchTokens();

        modalBody.innerHTML = `
          <p class="token-instructions">
            Device tokens allow the Overland iOS app to send location data to your account.
            Create a token and enter it in the Overland app's "Authorization Header" setting as:<br>
            <code style="background: var(--parchment-dark); padding: 0.2rem 0.4rem; border-radius: 2px;">Bearer YOUR_TOKEN</code>
          </p>

          ${newTokenValue ? `
            <div class="token-warning">
              <strong>Save this token now!</strong> It won't be shown again.
            </div>
            <div class="token-value">${newTokenValue}</div>
            <button class="btn btn-small" id="copyTokenBtn" style="margin-bottom: 1.5rem;">Copy Token</button>
          ` : ''}

          <div class="create-token-form">
            <input type="text" id="tokenNameInput" placeholder="Token name (e.g., iPhone)" maxlength="50">
            <button class="btn" id="createTokenBtn">Create</button>
          </div>

          <div class="detail-section-title">Your Tokens</div>

          ${tokens.length === 0 ? `
            <p style="color: var(--ink-light); text-align: center; padding: 2rem;">
              No device tokens yet. Create one to start tracking!
            </p>
          ` : `
            <div class="token-list">
              ${tokens.map(token => `
                <div class="token-item">
                  <div class="token-info">
                    <span class="token-name">${token.name}</span>
                    <span class="token-meta">
                      Created ${formatTime(token.createdAt)}
                      ${token.lastUsedAt ? ` · Last used ${formatRelativeTime(token.lastUsedAt)}` : ''}
                    </span>
                  </div>
                  <button class="btn btn-danger btn-small" data-token-id="${token.id}">Revoke</button>
                </div>
              `).join('')}
            </div>
          `}
        `;

        // Event listeners
        document.getElementById('createTokenBtn')?.addEventListener('click', handleCreateToken);
        document.getElementById('tokenNameInput')?.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') handleCreateToken();
        });
        document.getElementById('copyTokenBtn')?.addEventListener('click', () => {
          navigator.clipboard.writeText(newTokenValue);
          document.getElementById('copyTokenBtn').textContent = 'Copied!';
        });
        document.querySelectorAll('[data-token-id]').forEach(btn => {
          btn.addEventListener('click', () => handleDeleteToken(btn.dataset.tokenId));
        });
      } catch (error) {
        modalBody.innerHTML = `<div class="error-state">Failed to load tokens</div>`;
      }
    }

    async function handleCreateToken() {
      const input = document.getElementById('tokenNameInput');
      const name = input.value.trim();
      if (!name) {
        input.focus();
        return;
      }
      try {
        const result = await createToken(name);
        newTokenValue = result.token;
        await renderTokenModal();
      } catch (error) {
        alert('Failed to create token');
      }
    }

    async function handleDeleteToken(id) {
      if (!confirm('Revoke this token? Devices using it will stop working.')) return;
      try {
        await deleteToken(id);
        newTokenValue = null;
        await renderTokenModal();
      } catch (error) {
        alert('Failed to revoke token');
      }
    }

    // Format coordinates
    function formatCoord(value, isLat) {
      const dir = isLat ? (value >= 0 ? 'N' : 'S') : (value >= 0 ? 'E' : 'W');
      return `${Math.abs(value).toFixed(6)}° ${dir}`;
    }

    // Format timestamp
    function formatTime(isoString) {
      const date = new Date(isoString);
      return date.toLocaleString('en-US', {
        weekday: 'short',
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }

    // Format relative time
    function formatRelativeTime(isoString) {
      const now = new Date();
      const date = new Date(isoString);
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins} min ago`;
      if (diffHours < 24) return `${diffHours} hr ago`;
      if (diffDays < 7) return `${diffDays} days ago`;
      return formatTime(isoString);
    }

    // Parse motion field (API returns JSON string)
    function parseMotion(motion) {
      if (!motion) return [];
      if (Array.isArray(motion)) return motion;
      try {
        return JSON.parse(motion);
      } catch {
        return [];
      }
    }

    // Fetch latest location
    async function fetchLatestLocation() {
      try {
        const response = await fetch(`${API_BASE}/locations/latest`, { credentials: 'include' });
        if (response.status === 404) {
          return null;
        }
        if (response.status === 401) {
          throw new Error('Unauthorized');
        }
        if (!response.ok) throw new Error('Failed to fetch');
        return await response.json();
      } catch (error) {
        console.error('Error fetching latest location:', error);
        throw error;
      }
    }

    // Fetch locations
    async function fetchLocations(limit, offset, from, to) {
      const params = new URLSearchParams({ limit, offset });
      if (from) params.append('from', from);
      if (to) params.append('to', to);

      try {
        const response = await fetch(`${API_BASE}/locations?${params}`, { credentials: 'include' });
        if (response.status === 401) {
          throw new Error('Unauthorized');
        }
        if (!response.ok) throw new Error('Failed to fetch');
        return await response.json();
      } catch (error) {
        console.error('Error fetching locations:', error);
        throw error;
      }
    }

    // Fetch single location
    async function fetchLocation(id) {
      try {
        const response = await fetch(`${API_BASE}/locations/${id}`, { credentials: 'include' });
        if (response.status === 401) {
          throw new Error('Unauthorized');
        }
        if (!response.ok) throw new Error('Failed to fetch');
        return await response.json();
      } catch (error) {
        console.error('Error fetching location:', error);
        throw error;
      }
    }

    // Render latest location hero
    function renderHero(location) {
      if (!location) {
        heroSection.innerHTML = `
          <div class="hero-empty">
            <p>No location data recorded yet. Start tracking with the Overland app!</p>
          </div>
        `;
        return;
      }

      const { latitude, longitude, timestamp, altitude, speed, batteryLevel, motion } = location;
      const motionArray = parseMotion(motion);

      heroSection.innerHTML = `
        <div class="hero-label">
          <span class="pulse"></span>
          Last Known Position
        </div>
        <div class="hero-coords animate-in">
          <div class="coord">
            <span class="coord-label">Lat</span>
            <span class="coord-value">${formatCoord(latitude, true)}</span>
          </div>
          <div class="coord">
            <span class="coord-label">Lon</span>
            <span class="coord-value">${formatCoord(longitude, false)}</span>
          </div>
        </div>
        <div class="hero-meta animate-in stagger-1">
          <div class="meta-item">
            <span class="meta-label">Recorded</span>
            <span class="meta-value">${formatRelativeTime(timestamp)}</span>
          </div>
          ${altitude != null ? `
            <div class="meta-item">
              <span class="meta-label">Altitude</span>
              <span class="meta-value">${altitude.toFixed(1)} m</span>
            </div>
          ` : ''}
          ${speed != null ? `
            <div class="meta-item">
              <span class="meta-label">Speed</span>
              <span class="meta-value">${(speed * 3.6).toFixed(1)} km/h</span>
            </div>
          ` : ''}
          ${batteryLevel != null ? `
            <div class="meta-item">
              <span class="meta-label">Battery</span>
              <span class="meta-value">${Math.round(batteryLevel * 100)}%</span>
            </div>
          ` : ''}
          ${motionArray.length ? `
            <div class="meta-item">
              <span class="meta-label">Motion</span>
              <span class="meta-value">${motionArray.join(', ')}</span>
            </div>
          ` : ''}
        </div>
      `;
    }

    // Render location list
    function renderLocations(response) {
      const locations = response.data;
      const { total, hasMore } = response.pagination;
      totalLocations = total;

      if (!locations || locations.length === 0) {
        locationsList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">📍</div>
            <h3 class="empty-state-title">No locations found</h3>
            <p>Try adjusting your date filters or start recording with Overland.</p>
          </div>
        `;
        pagination.style.display = 'none';
        locationsCount.textContent = '';
        return;
      }

      locationsCount.textContent = `${total} locations recorded`;

      locationsList.innerHTML = `
        <div class="locations-list">
          ${locations.map((loc, i) => `
            <div class="location-card animate-in stagger-${Math.min(i + 1, 5)}" data-id="${loc.id}">
              <span class="location-index">#${loc.id}</span>
              <div class="location-main">
                <div class="location-coords">
                  ${formatCoord(loc.latitude, true)}, ${formatCoord(loc.longitude, false)}
                </div>
                <div class="location-time">${formatTime(loc.timestamp)}</div>
              </div>
              <div class="location-badges">
                ${loc.speed != null ? `<span class="badge">${(loc.speed * 3.6).toFixed(0)} km/h</span>` : ''}
                ${parseMotion(loc.motion).length ? `<span class="badge badge-motion">${parseMotion(loc.motion)[0]}</span>` : ''}
              </div>
              <span class="location-arrow">→</span>
            </div>
          `).join('')}
        </div>
      `;

      // Pagination
      const start = currentOffset + 1;
      const end = Math.min(currentOffset + LIMIT, total);
      paginationInfo.textContent = `${start}-${end} of ${total}`;

      prevPageBtn.disabled = currentOffset === 0;
      nextPageBtn.disabled = !hasMore;
      pagination.style.display = 'flex';

      // Add click listeners
      document.querySelectorAll('.location-card').forEach(card => {
        card.addEventListener('click', () => openDetailModal(card.dataset.id));
      });
    }

    // Render error state
    function renderError(element, message) {
      element.innerHTML = `
        <div class="error-state">
          <p>${message}</p>
          <button class="btn" style="margin-top: 1rem" onclick="location.reload()">Retry</button>
        </div>
      `;
    }

    // Open detail modal
    async function openDetailModal(id) {
      modalOverlay.classList.add('active');
      detailModal.classList.add('active');
      document.body.style.overflow = 'hidden';

      modalBody.innerHTML = `
        <div class="loading">
          <div class="loading-spinner"></div>
          <span class="loading-text">Loading details...</span>
        </div>
      `;

      try {
        const location = await fetchLocation(id);
        renderModalContent(location);
      } catch (error) {
        modalBody.innerHTML = `<div class="error-state">Failed to load location details</div>`;
      }
    }

    // Render modal content
    function renderModalContent(loc) {
      modalBody.innerHTML = `
        <div class="detail-section">
          <div class="detail-section-title">Coordinates</div>
          <div class="detail-grid">
            <div class="detail-item">
              <span class="detail-label">Latitude</span>
              <span class="detail-value large">${formatCoord(loc.latitude, true)}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Longitude</span>
              <span class="detail-value large">${formatCoord(loc.longitude, false)}</span>
            </div>
            <div class="detail-item full-width">
              <span class="detail-label">Timestamp</span>
              <span class="detail-value">${formatTime(loc.timestamp)}</span>
            </div>
          </div>
        </div>

        ${loc.altitude != null || loc.speed != null || loc.heading != null ? `
          <div class="detail-section">
            <div class="detail-section-title">Movement</div>
            <div class="detail-grid">
              ${loc.altitude != null ? `
                <div class="detail-item">
                  <span class="detail-label">Altitude</span>
                  <span class="detail-value">${loc.altitude.toFixed(1)} m</span>
                </div>
              ` : ''}
              ${loc.speed != null ? `
                <div class="detail-item">
                  <span class="detail-label">Speed</span>
                  <span class="detail-value">${(loc.speed * 3.6).toFixed(1)} km/h (${loc.speed.toFixed(2)} m/s)</span>
                </div>
              ` : ''}
              ${loc.heading != null ? `
                <div class="detail-item">
                  <span class="detail-label">Heading</span>
                  <span class="detail-value">${loc.heading.toFixed(0)}°</span>
                </div>
              ` : ''}
              ${parseMotion(loc.motion).length ? `
                <div class="detail-item">
                  <span class="detail-label">Motion States</span>
                  <span class="detail-value">${parseMotion(loc.motion).join(', ')}</span>
                </div>
              ` : ''}
            </div>
          </div>
        ` : ''}

        ${loc.horizontalAccuracy != null || loc.verticalAccuracy != null ? `
          <div class="detail-section">
            <div class="detail-section-title">Accuracy</div>
            <div class="detail-grid">
              ${loc.horizontalAccuracy != null ? `
                <div class="detail-item">
                  <span class="detail-label">Horizontal</span>
                  <span class="detail-value">± ${loc.horizontalAccuracy.toFixed(1)} m</span>
                </div>
              ` : ''}
              ${loc.verticalAccuracy != null ? `
                <div class="detail-item">
                  <span class="detail-label">Vertical</span>
                  <span class="detail-value">± ${loc.verticalAccuracy.toFixed(1)} m</span>
                </div>
              ` : ''}
            </div>
          </div>
        ` : ''}

        ${loc.batteryLevel != null || loc.wifi != null ? `
          <div class="detail-section">
            <div class="detail-section-title">Device Status</div>
            <div class="detail-grid">
              ${loc.batteryLevel != null ? `
                <div class="detail-item">
                  <span class="detail-label">Battery Level</span>
                  <span class="detail-value">${Math.round(loc.batteryLevel * 100)}%</span>
                </div>
              ` : ''}
              ${loc.wifi != null ? `
                <div class="detail-item">
                  <span class="detail-label">WiFi Connected</span>
                  <span class="detail-value">${loc.wifi ? 'Yes' : 'No'}</span>
                </div>
              ` : ''}
            </div>
          </div>
        ` : ''}

        <div class="detail-section">
          <div class="detail-section-title">Record Info</div>
          <div class="detail-grid">
            <div class="detail-item">
              <span class="detail-label">ID</span>
              <span class="detail-value">${loc.id}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Created At</span>
              <span class="detail-value">${formatTime(loc.createdAt)}</span>
            </div>
          </div>
        </div>
      `;
    }

    // Close modal
    function closeModal() {
      modalOverlay.classList.remove('active');
      detailModal.classList.remove('active');
      document.body.style.overflow = '';
    }

    // Load locations with current filters
    async function loadLocations() {
      locationsList.innerHTML = `
        <div class="loading">
          <div class="loading-spinner"></div>
          <span class="loading-text">Loading expedition log...</span>
        </div>
      `;
      pagination.style.display = 'none';

      try {
        const data = await fetchLocations(LIMIT, currentOffset, filters.from, filters.to);
        renderLocations(data);
      } catch (error) {
        renderError(locationsList, 'Failed to load location history. Please try again.');
      }
    }

    // Event Listeners
    prevPageBtn.addEventListener('click', () => {
      currentOffset = Math.max(0, currentOffset - LIMIT);
      loadLocations();
    });

    nextPageBtn.addEventListener('click', () => {
      currentOffset += LIMIT;
      loadLocations();
    });

    applyFilterBtn.addEventListener('click', () => {
      filters.from = fromDateInput.value ? new Date(fromDateInput.value).toISOString() : null;
      filters.to = toDateInput.value ? new Date(toDateInput.value).toISOString() : null;
      currentOffset = 0;
      loadLocations();
      loadMapData();
    });

    clearFilterBtn.addEventListener('click', () => {
      fromDateInput.value = '';
      toDateInput.value = '';
      filters = { from: null, to: null };
      currentOffset = 0;
      loadLocations();
      loadMapData();
    });

    modalClose.addEventListener('click', closeModal);
    modalOverlay.addEventListener('click', closeModal);
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeModal();
    });

    // Show unauthenticated state
    function showUnauthenticated() {
      heroSection.innerHTML = `
        <div class="hero-empty">
          <p>Please log in with GitHub to view your location data.</p>
        </div>
      `;
      mapLoading.style.display = 'none';
      locationsList.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">🔐</div>
          <h3 class="empty-state-title">Authentication Required</h3>
          <p>Log in to access your location history and start tracking.</p>
        </div>
      `;
      pagination.style.display = 'none';
    }

    // Handle auth callback (token passed via URL to work around Vercel rewrite cookie issues)
    function handleAuthCallback() {
      if (window.location.pathname === '/__auth_callback') {
        const params = new URLSearchParams(window.location.search);
        const token = params.get('token');
        const returnTo = params.get('returnTo') || '/';

        if (token) {
          // Set the session cookie client-side (Better Auth cookie name)
          const maxAge = 30 * 24 * 60 * 60; // 30 days in seconds
          document.cookie = `overland.session_token=${token}; path=/; max-age=${maxAge}; SameSite=Lax`;
        }

        // Clean up URL and redirect
        window.location.replace(returnTo);
        return true;
      }
      return false;
    }

    // Initialize
    async function init() {
      // Handle auth callback first
      if (handleAuthCallback()) {
        return; // Will redirect, don't continue init
      }

      // Check authentication first
      const isAuthenticated = await checkAuth();

      if (!isAuthenticated) {
        showUnauthenticated();
        // Still initialize map for visual appeal, but don't load data
        initMap();
        return;
      }

      // Initialize the map
      initMap();

      // Fetch latest location
      let latestLocation = null;
      try {
        latestLocation = await fetchLatestLocation();
        renderHero(latestLocation);
      } catch (error) {
        renderError(heroSection, 'Failed to fetch latest location');
      }

      // Load map data with latest location marker
      loadMapData(latestLocation);

      // Fetch location history
      loadLocations();
    }

    init();
  </script>
</body>
</html>
